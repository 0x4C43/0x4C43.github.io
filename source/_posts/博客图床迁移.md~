---
title: 博客图床迁移
tags:
  - 图床
categories: Others
keywords:
  - 图床
translate_title: blog-map-bed-migration
date: 2018-10-29 18:20:24
---

博客搭建的时候选择了七牛云作为图床，到目前为止往上传了大概 100 张图片。近日收到七牛云测试域名回收的通知，只好另选其它云存储作为博客图床，网络上已有图床迁移方法，遂参考并记录于此。

# 0x01 下载图片
七牛云提供命令行工具 [qshell](https://developer.qiniu.com/kodo/tools/1302/qshell#2) 操作对象存储，可以使用该工具将已有数据同步到本地。

## 1. 密钥设置
首先需要设置密钥，密钥 `ak` 与 `sk` 可在“个人面板/密钥管理”中查看。
```python
$ qshell account ak sk
```
## 2. 同步数据
使用 [qdownload](https://github.com/qiniu/qshell/blob/master/docs/qdownload.md) 命令可将图片同步到本地，该功能是收费的，但是通过设置 `cdn_domain` 参数可免费使用 10G 的流量。该命令使用方法如下，其中 `LocalDownloadConfig` 为本地下载的配置文件。
```python
$ qshell qdownload [<ThreadCount>] <LocalDownloadConfig>
```
为能使用免费流量，新建如下配置文件，其中 `bucket` 为存储空间名称，`cdn_domain` 为需同步存储空间的外部默认域名。
```python
{
    "dest_dir"   :   "/home/lc/Desktop/images",
    "bucket"     :   "hexo",
    "prefix"     :   "",
    "suffixes"   :   "",
    "cdn_domain" :   "http://ooyovxue7.bkt.clouddn.com",
    "referer"    :   "",
    "log_file"   :   "download.log",
    "log_level"  :   "info",
    "log_rotate" :   1,
    "log_stdout" :   false
}
```
命令执行完后，所有图片将下载到 `dest_dir` 设定的目录中。

# 0x02 腾讯云 COS
## 1. 上传图片
首先创建存储空间，并设置访问权限为**公有读私有写**，创建好后将下载的图片批量上传至 COS。为方便替换已有文章中图片链接，应保留七牛云中数据的文件夹结构。

此外，为了防止盗链导致免费流量被耗尽，需要设置防盗链，将博客域名加入白名单中。但设置之后，本地文章中无法正常访问图片，所以酌情设置该功能。

## 2. 修改链接
将图片上传到腾讯云 COS 之后，即可正常访问这些图片。接下来需要修改已有文章中的图片链接，将链接中的七牛云域名 `old_domain_name` 替换为腾讯云域名 `new_domain_name`（在“基础配置/访问域名”中查看），下面使用 `sed` 命令进行批量修改。
```python
sed -i 's#($old_domain_name#($new_domain_name#g' /path_to_blog/source/_posts/*.md
```
所有链接修改完后，博客图床迁移便完成了。

2020.04.05 更新：近期腾讯云 COS 完成商业版测试，后续 COS 不再免费。因为贫穷，最终又把图床迁移到 Github。

# 0x03 PicGo
[PicGo](https://molunerfinn.com/PicGo/) 是一款图片上传工具，可支持多种图床，其中包括腾讯云 COS。配置方法参看 [官方文档](https://github.com/Molunerfinn/PicGo/wiki/%E8%AF%A6%E7%BB%86%E7%AA%97%E5%8F%A3%E7%9A%84%E4%BD%BF%E7%94%A8#%E8%85%BE%E8%AE%AF%E4%BA%91cos)，由于主账户权限较大，基于安全考虑，建议新建一个子账户，并对该子账户只授予 COS 读写权限，具体设置方法参考 [使用子账号对 COS 进行授权](https://cloud.tencent.com/document/product/436/11714)。  
![](https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586020649_20181029174328.png)


____
References:   
[1] [七牛测试域名回收迁移博客图床到腾讯云](https://sjq597.github.io/2018/10/13/%E4%B8%83%E7%89%9B%E6%B5%8B%E8%AF%95%E5%9F%9F%E5%90%8D%E5%9B%9E%E6%94%B6%E8%BF%81%E7%A7%BB%E5%8D%9A%E5%AE%A2%E5%9B%BE%E5%BA%8A%E5%88%B0%E8%85%BE%E8%AE%AF%E4%BA%91/)   
[2] [把博客图床从七牛云迁移到腾讯云](https://jdhao.github.io/2018/10/20/qiuniu_migrate_to_tencent_cos/)  